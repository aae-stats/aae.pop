<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Including demographic processes in a population model • aae.pop</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Including demographic processes in a population model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">aae.pop</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/get_started.html">get started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/including_processes.html">Including processes</a></li>
    <li><a class="dropdown-item" href="../articles/beyond_defaults.html">Beyond defaults</a></li>
    <li><a class="dropdown-item" href="../articles/metapopulations.html">Metapopulations</a></li>
    <li><a class="dropdown-item" href="../articles/multiple_species.html">Multiple species</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-examples" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">examples</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-examples">
<li><a class="dropdown-item" href="../articles/macperch_example.html">Macquarie perch</a></li>
    <li><a class="dropdown-item" href="../articles/scenarios_example.html">Comparing scenarios</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../CODE_OF_CONDUCT.html">code of conduct</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/aae-stats/aae.pop" aria-label="View source of GitHub"><span class="fa fab fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Including demographic processes in a population model</h1>
                        <h4 data-toc-skip class="author">Jian Yen</h4>
            
            <h4 data-toc-skip class="date">07/01/2026</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/aae-stats/aae.pop/blob/v0.2.0/vignettes/including_processes.Rmd" class="external-link"><code>vignettes/including_processes.Rmd</code></a></small>
      <div class="d-none name"><code>including_processes.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="demographic-processes">Demographic processes?<a class="anchor" aria-label="anchor" href="#demographic-processes"></a>
</h2>
<p>This is a broad term that could mean many things.
<code>aae.pop</code> focuses on five main processes:</p>
<ul>
<li><p>demographic stochasticity: random variation in the outcomes of
individual processes (e.g. birth, death), resulting in variation in
population abundances.</p></li>
<li><p>environmental stochasticity: random variation in external
conditions, resulting in variation in the vital rates (i.e., the
population matrix).</p></li>
<li><p>density dependence: variation in vital rates or population
outcomes that depends on the abundance of the population. Density
dependence can be negative (e.g., due to limited resources) or positive
(e.g., Allee effects).</p></li>
<li><p>covariate effects: the influence of covariates on the population
matrix. In <code>aae.pop</code>, covariate effects are included
primarily to allow the population matrix to change through time in
response to external factors (e.g., weather, habitat availability,
management interventions).</p></li>
<li><p>additions or removals: any processes that lead to individuals
being added to or removed from a population. Additions and removals are
defined broadly but can capture things like population augmentation
(e.g., stocking or releases of captive-bred individuals) and targeted
removals (e.g., angling or predation).</p></li>
</ul>
<p>Two additional processes, <em>dispersal</em> and <em>interspecific
interactions</em>, are covered in the <a href="metapopulations.html">Metapopulations</a> and <a href="multiple_species.html">Multiple species</a> vignettes.</p>
</div>
<div class="section level2">
<h2 id="an-aside-masks">An aside: masks<a class="anchor" aria-label="anchor" href="#an-aside-masks"></a>
</h2>
<p>The processes above are unlikely to have consistent effects across
all vital rates or all classes in a population. To deal with this,
<code>aae.pop</code> is built around a concept of <em>masks</em>. Masks
are used to select specific elements of the population matrix, and only
these elements are altered by a given process.</p>
<p>Masks are paired with functions when defining all of the above
processes. Masks tell R which cells to target, functions tell R what to
do to these cells.</p>
<p>Several helper functions are included to define common masks. These
include the <code>reproduction</code>, <code>survival</code>, and
<code>transition</code> regions of the matrix discussed in the <a href="get_started.html">getting started</a> vignette, as well as masks
to select an entire population matrix (<code>all_cells</code>) or
abundance vector (<code>all_classes</code>).</p>
<p>The masks defined in <code>aae.pop</code> return a
<code>TRUE</code>/<code>FALSE</code> matrix or vector that selects the
required cells. Masks are defined in this way because
<code>aae.pop</code> flattens the population matrix in all internal
calculations, which breaks cell-based subsetting (i.e., the
<code>[i, j]</code> R notation will not work). It is possible (but not
advised) to work around this. The discussion <a href="#nomask">below</a>
introduces one way to work around masks and highlights why this might
not be a good idea.</p>
</div>
<div class="section level2">
<h2 id="back-to-demographic-processes">Back to demographic processes<a class="anchor" aria-label="anchor" href="#back-to-demographic-processes"></a>
</h2>
<div class="section level3">
<h3 id="a-basic-model">A basic model<a class="anchor" aria-label="anchor" href="#a-basic-model"></a>
</h3>
<p>Let’s start with the basic model used in the <a href="get_started.html">Getting started</a> vignette. This was a Leslie
matrix with five age classes, with individuals reproducing from ages
3-5.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">popmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">2</span>,    <span class="fl">4</span>,    <span class="fl">7</span><span class="op">)</span>,  <span class="co"># reproduction from 3-5 year olds</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">0</span><span class="op">)</span>,  <span class="co"># survival from age 1 to 2</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,    <span class="fl">0.45</span>, <span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">0</span><span class="op">)</span>,  <span class="co"># survival from age 2 to 3</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">0.70</span>, <span class="fl">0</span>,    <span class="fl">0</span><span class="op">)</span>,  <span class="co"># survival from age 3 to 4</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">0.85</span>, <span class="fl">0</span><span class="op">)</span>   <span class="co"># survival from age 4 to 5</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This is sufficient to start simulating population dynamics, using the
<code>dynamics</code> and <code>simulate</code> functions. However,
adding additional processes requires a few more steps first.</p>
</div>
<div class="section level3">
<h3 id="demographic-stochasticity">Demographic stochasticity<a class="anchor" aria-label="anchor" href="#demographic-stochasticity"></a>
</h3>
<p>Random variation in individual outcomes is a key feature of most
population models. This variation is most important (and influential)
when populations are small, so that a few small events (e.g., several
individuals failing to reproduce) can have a big effect on population
outcomes.</p>
<p>Demographic stochasticity will be defined here with a single
<code>mask</code> and its corresponding <code>function</code>. The
simplest form of demographic stochasticity in this case is Poisson
variation around the expected number of individuals in the next
generation. This can be coded as:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demostoch_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/masks.html">all_classes</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span> <span class="co"># affects all classes</span></span>
<span><span class="va">demostoch_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, lambda <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here, the <code>mask</code> selects all classes in the population
vector and the <code>function</code> takes this vector <code>x</code>
and returns random Poisson variates with mean equal to <code>x</code>.
Note that this function potentially allows the number of surviving
individuals in a class to exceed the number of available individuals
because the Poisson distribution does not have an upper bound. A
workaround for this, using the Binomial distribution, is covered in the
<a href="beyond_defaults.html">Beyond defaults</a> vignette.</p>
<p>The <code>mask</code>/<code>function</code> pair can be combined into
a single object with the <code>demographic_stochasticity</code>
function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demostoch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stochasticity.html">demographic_stochasticity</a></span><span class="op">(</span></span>
<span>  masks <span class="op">=</span> <span class="va">demostoch_mask</span>,</span>
<span>  funs <span class="op">=</span> <span class="va">demostoch_fn</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The resulting <code>demostoch</code> object can be passed directly to
<code>dynamics</code>, along with the population matrix. In turn, this
creates a <code>dynamics</code> object that can be used in
<code>simulate</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create population dynamics object</span></span>
<span><span class="va">popdyn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dynamics.html">dynamics</a></span><span class="op">(</span><span class="va">popmat</span>, <span class="va">demostoch</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate population dynamics</span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span><span class="va">popdyn</span>, nsim <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the population trajectories</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims</span>, col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="including_processes_files/figure-html/unnamed-chunk-4-1.png" class="r-plt" alt="Line plot showing 100 simulated trajectories initialised with the same initial conditions. Lines are variable due to demographic stochasticity and range from slightly increasing trajectories to complete extinction." width="700"></p>
<p>This simple example includes one mask/function pair, but the
<code>demographic_stochasticity</code> function can chain together as
many different mask/function pairs as required. In these cases, there
should be one mask for each function, and the set of masks/functions
should be passed to <code>demographic_stochasiticity</code> as a list
(e.g., <code>masks = list(demostoch_mask1, demostoch_mask2)</code>).</p>
</div>
<div class="section level3">
<h3 id="environmental-stochasticity">Environmental Stochasticity<a class="anchor" aria-label="anchor" href="#environmental-stochasticity"></a>
</h3>
<p>Environmental stochasticity will be defined here with two masks and
their corresponding functions. The simplest form of variation in
reproduction is Poisson variation around the expected number of new
individuals. This can be coded as:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reproduction_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/masks.html">reproduction</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="co"># only ages 3-5 reproduce</span></span>
<span><span class="va">reproduction_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, lambda <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here, the <code>mask</code> selects the reproductive output of age
classes 3 to 5 in the population matrix and the <code>function</code>
takes this vector <code>x</code> and returns random Poisson variates
with mean equal to <code>x</code>.</p>
<p>The second <code>mask</code>/<code>function</code> pair will add
variation in survival outcomes. In this case, a simple form of variation
is to add or subtract some small value from the survival probabilities.
This can be coded up as:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">transition_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/masks.html">transition</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span> <span class="co"># all classes this time</span></span>
<span><span class="va">transition_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># add a random deviation to x</span></span>
<span>  <span class="va">deviation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>, max <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">deviation</span></span>
<span>  </span>
<span>  <span class="co"># make sure the result isn't negative or greater than 1</span></span>
<span>  <span class="va">x</span><span class="op">[</span><span class="va">x</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">x</span><span class="op">[</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="co"># return the value</span></span>
<span>  <span class="va">x</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here, the <code>mask</code> selects all elements on the sub-diagonal
of the population matrix, and the <code>function</code> takes some
vector <code>x</code> and returns a new value with a deviation between
-0.1 and 0.1. There is one extra check in the function to make sure that
the new probabilities are still probabilities (i.e., still between 0 and
1).</p>
<p>These two <code>mask</code>/<code>function</code> pairs can be
combined into a single object with the
<code>environmental_stochasticity</code> function.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">envstoch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stochasticity.html">environmental_stochasticity</a></span><span class="op">(</span></span>
<span>  masks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">reproduction_mask</span>, <span class="va">transition_mask</span><span class="op">)</span>,</span>
<span>  funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">reproduction_fn</span>, <span class="va">transition_fn</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The resulting <code>envstoch</code> object can be passed directly to
<code>dynamics</code>, along with the population matrix. In turn, this
creates a <code>dynamics</code> object that can be used in
<code>simulate</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create population dynamics object</span></span>
<span><span class="va">popdyn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dynamics.html">dynamics</a></span><span class="op">(</span><span class="va">popmat</span>, <span class="va">envstoch</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate population dynamics</span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span><span class="va">popdyn</span>, nsim <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the population trajectories</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims</span>, col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="including_processes_files/figure-html/unnamed-chunk-8-1.png" class="r-plt" alt="Line plot showing 100 simulated trajectories initialised with the same initial conditions. Lines are variable due to environmental stochasticity and range from slightly increasing trajectories to slightly decreasing." width="700"></p>
<p>It is easy to include both environmental and demographic
stochasticity in the same model. The <code>dynamics</code> call simply
needs both <code>envstoch</code> and <code>demostoch</code> objects.
This is a case where the <code>update</code> function comes in handy.
Rather than re-defining the population dynamics object, the existing
version of <code>popdyn</code> (which included <code>popmat</code> and
<code>envstoch</code>) can simply be updated to include
<code>demostoch</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># update population dynamics object</span></span>
<span><span class="va">popdyn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">popdyn</span>, <span class="va">demostoch</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate population dynamics</span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span><span class="va">popdyn</span>, nsim <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the population trajectories</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims</span>, col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="including_processes_files/figure-html/unnamed-chunk-9-1.png" class="r-plt" alt="Line plot showing 100 simulated trajectories initialised with the same initial conditions. Lines are variable due to environmental and demographic stochasticity and range from slightly increasing trajectories to complete extinction." width="700"></p>
</div>
<div class="section level3">
<h3 id="density-dependence">Density dependence<a class="anchor" aria-label="anchor" href="#density-dependence"></a>
</h3>
<p>Density dependence occurs when vital rates or individual outcomes
depend on population abundance. The most common form of density
dependence in population ecology is <em>negative density
dependence</em>, that is, a reduction in vital rates with increases in
population abundance. Negative density dependence is typically observed
as changes in reproduction due to, for example, increased competition
for resources resulting in high mortality of new individuals.</p>
<p>Density dependence can be included in exactly the same way as
environmental stochasticity: a <code>mask</code> tells R which cells in
the population matrix are affected by abundances and a
<code>function</code> tells R what to do with these cells. In this case,
the <code>function</code> is passed the vital rates as well as the
vector of abundances in each population class.</p>
<p><code>aae.pop</code> has pre-defined functions for two common forms
of density dependence: the <em>Ricker</em> model and the
<em>Beverton-Holt</em> model. The Ricker model assumes that mortality
rates of new individuals are proportional to adult population size due
to <em>scramble competition</em> (equal division of resources). The
Beverton-Holt model assumes that mortality rates of new individuals are
linearly dependent on the number of individuals due to <em>contest
competition</em> (unequal division of resources). Importantly, the
Ricker model is <em>overcompensatory</em>, which means it can increase
mortality rates to the point of complete mortality. This does not occur
under the Beverton-Holt model.</p>
<p>In <code>aae.pop</code>, both models are specified with two
parameters: <code>k</code>, that represents the <em>carrying
capacity</em> of the population; and <code>theta</code>, which
represents the strength of density dependence. <code>theta</code>
re-scales population sizes, so is mathematically equivalent to adjusting
<code>k</code> (e.g., <code>theta = 0.5; k = k</code> and
<code>theta = 1; k = 2 * k</code> will give the same outcome). Both
functions include one extra argument, <code>exclude</code>, which allows
estimates of carrying capacity to be defined for a subset of population
classes (e.g., adult abundances only). A Ricker model can be specified
as follows:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># specify a Ricker model for density dependence</span></span>
<span><span class="va">dd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/density_dependence.html">density_dependence</a></span><span class="op">(</span></span>
<span>  masks <span class="op">=</span> <span class="fu"><a href="../reference/masks.html">reproduction</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, <span class="co"># only adults reproduce</span></span>
<span>  funs <span class="op">=</span> <span class="fu"><a href="../reference/density_functions.html">ricker</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">40</span>, exclude <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>      <span class="co"># set k based on adult abundances</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># update the population dynamics object to include density dependence</span></span>
<span><span class="va">popdyn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">popdyn</span>, <span class="va">dd</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate population dynamics</span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span><span class="va">popdyn</span>, nsim <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the population trajectories</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims</span>, col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="including_processes_files/figure-html/unnamed-chunk-10-1.png" class="r-plt" alt="Line plot showing 100 simulated trajectories initialised with the same initial conditions. Lines are variable due to density dependence and environmental and demographic stochasticity and range from slightly decreasing trajectories to complete extinction." width="700"></p>
<p>Density dependence can take many other forms. These forms may include
positive density dependence (e.g., Allee effects) or may affect adult
abundances as well as reproduction. The next section introduces an
example of the latter.</p>
</div>
<div class="section level3">
<h3 id="a-different-form-of-density-dependence">A different form of density dependence<a class="anchor" aria-label="anchor" href="#a-different-form-of-density-dependence"></a>
</h3>
<p>Density dependence is most commonly assumed to affect only the new
individuals entering the population. However, it is possible that
density dependence also affects adults, for example, when high
abundances limit access to suitable habitat. Effects on adult survival
could be modelled using the approach outlined in the previous section,
with <code>transition</code> or <code>survival</code> masks alongside
the <code>reproduction</code> mask.</p>
<p>An alternative approach is to model density dependence through its
direct effects on population abundances. Although not linked directly to
vital rates (e.g., survival), this approach can be easier to implement
and can capture processes that do not directly affect vital rates, such
as fishing, hunting, or logging.</p>
<p>The <code>add_remove_pre</code> and <code>add_remove_post</code>
functions can be used to define this form of density dependence
(<code>_pre</code>: before reproduction; <code>_post</code>: after
reproduction). These functions are described in more detail below and
replace the now-deprecated <code>density_dependence_n</code> function.
In this case, the <code>mask</code> needs to select the relevant classes
in the population, and the <code>function</code> takes only one
argument, the vector of population abundances. This approach can be
implemented as follows:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># specify density dependence that removes 10 % of adults in each generation</span></span>
<span><span class="va">dd_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_remove.html">add_remove_post</a></span><span class="op">(</span></span>
<span>  masks <span class="op">=</span> <span class="fu"><a href="../reference/masks.html">all_classes</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, <span class="co"># want to focus on adults</span></span>
<span>  funs <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="fl">0.9</span> <span class="op">*</span> <span class="va">n</span>               <span class="co"># define in-line function to return</span></span>
<span>  <span class="co">#   90 % of adult population</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a new population dynamics object</span></span>
<span><span class="va">popdyn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dynamics.html">dynamics</a></span><span class="op">(</span><span class="va">popmat</span>, <span class="va">envstoch</span>, <span class="va">demostoch</span>, <span class="va">dd_n</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate population dynamics</span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span><span class="va">popdyn</span>, nsim <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the population trajectories</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims</span>, col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="including_processes_files/figure-html/unnamed-chunk-11-1.png" class="r-plt" alt="Line plot showing 100 simulated trajectories initialised with the same initial conditions. Lines are variable due to environmental and demographic stochasticity and removals from the population and range from slightly decreasing trajectories to complete extinction." width="700"></p>
</div>
<div class="section level3">
<h3 id="covariates">Covariates<a class="anchor" aria-label="anchor" href="#covariates"></a>
</h3>
<p>Population dynamics often depend on external factors
(<code>covariates</code>, here). <code>aae.pop</code> uses the
<code>mask</code>/<code>function</code> approach described above to
include the effects of covariates on vital rates. The
<code>function</code> takes the vital rates as the first argument,
followed by any arguments required to specify covariate values or their
effects. An example illustrates this most clearly:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up 20 years of covariates, such as proportion of available nesting sites</span></span>
<span><span class="va">nesting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">20</span>, min <span class="op">=</span> <span class="fl">0.5</span>, max <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span>    <span class="co"># 50 % to 100 % of total sites available in each year</span></span>
<span></span>
<span><span class="co"># define the mask</span></span>
<span><span class="va">covar_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/masks.html">reproduction</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>  <span class="co"># assume nesting sites only affect reproduction</span></span>
<span></span>
<span><span class="co"># define a function that links vital rates to the covariates</span></span>
<span><span class="co">#   (dots to soak up any extra arguments passed to other functions)</span></span>
<span><span class="va">covar_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">nests</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">*</span> <span class="va">nests</span>    <span class="co"># really simple function, assume the proportion of successful reproduction</span></span>
<span>  <span class="co">#   attempts is equal to the proportion of nests</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># combine this into a covariates term</span></span>
<span><span class="va">covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/covariates.html">covariates</a></span><span class="op">(</span><span class="va">covar_mask</span>, <span class="va">covar_fn</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create population dynamics object (without density dependence)</span></span>
<span><span class="va">popdyn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dynamics.html">dynamics</a></span><span class="op">(</span><span class="va">popmat</span>, <span class="va">envstoch</span>, <span class="va">demostoch</span>, <span class="va">covs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate population dynamics</span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span></span>
<span>  <span class="va">popdyn</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>covariates <span class="op">=</span> <span class="fu"><a href="../reference/covariates.html">format_covariates</a></span><span class="op">(</span><span class="va">nesting</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the population trajectories</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims</span>, col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="including_processes_files/figure-html/unnamed-chunk-12-1.png" class="r-plt" alt="Line plot showing 100 simulated trajectories initialised with the same initial conditions. Lines are variable due to environmental and demographic stochasticity and a nesting covariate and range from slightly decreasing trajectories to complete extinction." width="700"></p>
<p>Specifying a <code>covariates</code> term does not automatically
include covariates in the model. Note that the <code>nesting</code>
variable also had to be passed to <code>simulate</code> via the
<code>args</code> argument. The reason for this is that it allows a
single population dynamics object (<code>popdyn</code>, above) to be
used with multiple different sets of covariates, without re-compiling
the <code>dynamics</code> object each time.</p>
<p>The <code>format_covariates</code> function is included to format
covariate values into a list with one element per time step. These
formatted covariates can be combined with static covariates by collating
everything into a super-list:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span></span>
<span>  <span class="va">popdyn</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/covariates.html">format_covariates</a></span><span class="op">(</span><span class="va">nesting</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>static_argument1 <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>static_argument2 <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><code>aae.pop</code> assumes that at least one argument to
<code>covariates</code> changes through time, so a consequence of
specifying covariates is that the vector/matrix of covariates determines
the number of simulated time steps (<code>n_time</code>). In the above
example, there were 20 values of <code>nesting</code>, which translates
to 21 time steps (initial condition plus 20 updates).</p>
<p>It is assumed that covariates will be passed as a list with one
element for each time step. More complex <code>covariate</code> terms
are possible, such as a combination of static and dynamic arguments or
functions that specify arguments based on the current state of the
population. These terms can be passed to <code>simulate</code> via the
<code>args</code> argument (see help files for
<code>format_covariates</code> for examples).</p>
</div>
<div class="section level3">
<h3 id="fine-grained-control-of-covariate-effects">Fine-grained control of covariate effects<a class="anchor" aria-label="anchor" href="#fine-grained-control-of-covariate-effects"></a>
</h3>
<p>Simulated populations can include The default <code>covariates</code>
terms are applied consistently to all replicate trajectories. In some
cases, it may be useful to specify covariate effects specific to each
trajectory. The <code>replicated_covariates</code> process is included
to address this situation, and allows covariate functions to act on the
full vector of vital rates with replicate-specific arguments and
effects.</p>
<p>The simplest way to set up (and visualise) a
<code>replicated_covariates</code> term is to define a matrix with
<code>nsim</code> columns and <code>ntime</code> rows. Each column in
this matrix specifies the covariate values/arguments applied to a single
replicate trajectory, and each row specifies the effects (for all
replicates) at a single time step.</p>
<p>One application of <code>replicated_covariates</code> (and the reason
this approach was developed) is to allow both variation and uncertainty
in vital rates in a single simulation. With this structure, the input
matrix can be defined with variation (e.g., representing environmental
variability) around different mean values (representing uncertainty),
without having to run multiple simulations.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up 20 years of covariates, such as proportion of available nesting sites,</span></span>
<span><span class="co">#   but now with a different minimum (and, therefore, mean) value for each replicate</span></span>
<span><span class="va">nesting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">100</span>, min <span class="op">=</span> <span class="fl">0.5</span>, max <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">20</span>, min <span class="op">=</span> <span class="va">x</span>, max <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define the mask</span></span>
<span><span class="va">covar_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/masks.html">reproduction</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>  <span class="co"># assume nesting sites only affect reproduction</span></span>
<span></span>
<span><span class="co"># define a function that links vital rates to the covariates</span></span>
<span><span class="co">#   (dots to soak up any extra arguments passed to other functions)</span></span>
<span><span class="va">covar_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">nests</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">*</span> <span class="va">nests</span>    <span class="co"># really simple function, assume the proportion of successful reproduction</span></span>
<span>  <span class="co">#   attempts is equal to the proportion of nests</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># combine this into a covariates term</span></span>
<span><span class="va">covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/replicated_covariates.html">replicated_covariates</a></span><span class="op">(</span><span class="va">covar_mask</span>, <span class="va">covar_fn</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create population dynamics object (without density dependence)</span></span>
<span><span class="va">popdyn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dynamics.html">dynamics</a></span><span class="op">(</span><span class="va">popmat</span>, <span class="va">envstoch</span>, <span class="va">demostoch</span>, <span class="va">covs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate population dynamics</span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span></span>
<span>  <span class="va">popdyn</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>replicated_covariates <span class="op">=</span> <span class="fu"><a href="../reference/covariates.html">format_covariates</a></span><span class="op">(</span><span class="va">nesting</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the population trajectories</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims</span>, col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="including_processes_files/figure-html/unnamed-chunk-14-1.png" class="r-plt" alt="Line plot showing 100 simulated trajectories initialised with the same initial conditions. Lines are variable due to environmental and demographic stochasticity and replicate-specific covariates and range from slightly increasing trajectories to complete extinction." width="700"></p>
</div>
<div class="section level3">
<h3 id="adding-or-removing-individuals-from-a-population">Adding or removing individuals from a population<a class="anchor" aria-label="anchor" href="#adding-or-removing-individuals-from-a-population"></a>
</h3>
<p>Many processes might lead to individuals being added to or removed
from a population. The <code>add_remove_pre</code> and
<code>add_remove_post</code> functions are defined generically to
capture any such process, with the <code>pre</code> version being
applied prior to reproduction and the <code>post</code> version applied
following reproduction. Similar to demographic stochasticity, additions
and removals act on the population state vector (the counts in each
class) rather than the population matrix (the vital rates). Importantly,
<code>add_remove_pre</code> is the only way in which the state vector
can be modified before reproduction.</p>
<p>Examples of additions include fish stocking and releases of
captive-bred individuals. Examples of removals include angling or
predation of individuals, noting that both could also be applied as
covariates acting on survival rates. A simple example can illustrate the
general approach.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up a release of 10 individuals each year into the first age class,</span></span>
<span><span class="co">#   occurring after reproduction</span></span>
<span><span class="va">captives</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_remove.html">add_remove_post</a></span><span class="op">(</span></span>
<span>  masks <span class="op">=</span> <span class="fu"><a href="../reference/masks.html">all_classes</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  funs <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># repeat to remove 2 adults via predation each year, prior to reproduction</span></span>
<span><span class="va">predators</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_remove.html">add_remove_pre</a></span><span class="op">(</span></span>
<span>  masks <span class="op">=</span> <span class="fu"><a href="../reference/masks.html">all_classes</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  funs <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="fl">2</span>, <span class="va">x</span> <span class="op">-</span> <span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create population dynamics object (without density dependence)</span></span>
<span><span class="va">popdyn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dynamics.html">dynamics</a></span><span class="op">(</span><span class="va">popmat</span>, <span class="va">envstoch</span>, <span class="va">demostoch</span>, <span class="va">captives</span>, <span class="va">predators</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate population dynamics</span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span></span>
<span>  <span class="va">popdyn</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the population trajectories</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims</span>, col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="including_processes_files/figure-html/unnamed-chunk-15-1.png" class="r-plt" alt="Line plot showing 100 simulated trajectories initialised with the same initial conditions. Lines are variable due to environmental and demographic stochasticity and additions to and removals from the population and range from slightly increasing trajectories to slightly decreasing." width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="nomask">What if I don’t want to use masks?<a class="anchor" aria-label="anchor" href="#nomask"></a>
</h2>
<p>The <code>mask</code>/<code>function</code> approach is central to
<code>aae.pop</code>. This approach allows multiple functions to be
combined into a single term and makes it easier to keep track of (and
update) individual functions or masks. A secondary reason for this
approach is computational. Rarely will any demographic processes act on
the entire population matrix. When dealing with large matrices (e.g.,
50-100 classes), it’s much more efficient to pass small parts of the
matrix than the entire matrix.</p>
<p>There might be situations where the entire population matrix does
need to be modified by a given process. This is still supported in
<code>aae.pop</code> through the <code>all_cells</code>
<code>mask</code>. However, it isn’t possible to subset the matrix
within a <code>function</code> using R’s standard <code>[i, j]</code>
notation. This is because the functions within <code>aae.pop</code>
receive a flattened (and masked) version of the population matrix, which
actually looks like:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># reproduction mask</span></span>
<span><span class="va">popmat</span><span class="op">[</span><span class="fu"><a href="../reference/masks.html">reproduction</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2 4 7</span></span></code></pre>
<p>or</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># transition mask</span></span>
<span><span class="va">popmat</span><span class="op">[</span><span class="fu"><a href="../reference/masks.html">transition</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.25 0.45 0.70 0.85</span></span></code></pre>
<p>or</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># all elements</span></span>
<span><span class="va">popmat</span><span class="op">[</span><span class="fu"><a href="../reference/masks.html">all_cells</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 0.00 0.25 0.00 0.00 0.00 0.00 0.00 0.45 0.00 0.00 2.00 0.00 0.00 0.70 0.00</span></span>
<span><span class="co">## [16] 4.00 0.00 0.00 0.00 0.85 7.00 0.00 0.00 0.00 0.00</span></span></code></pre>
<p>If it’s essential to use <code>[i, j]</code> subsetting inside a
function, a workaround is to reconstruct the matrix within the function
by passing the dimensions through the <code>args</code> argument in
<code>simulate</code>. This might look a bit like:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define a function</span></span>
<span><span class="va">no_mask_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">dim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># reconstruct matrix</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">x</span>, dim <span class="op">=</span> <span class="va">dim</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># change elements with [i, j] notation</span></span>
<span>  <span class="va">x</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.6</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">x</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1.25</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># return</span></span>
<span>  <span class="va">x</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># set this up as a form of environmental stochasticity</span></span>
<span><span class="va">envstoch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stochasticity.html">environmental_stochasticity</a></span><span class="op">(</span></span>
<span>  masks <span class="op">=</span> <span class="fu"><a href="../reference/masks.html">all_cells</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span>,  <span class="co"># pass the entire matrix</span></span>
<span>  funs <span class="op">=</span> <span class="va">no_mask_fn</span>           <span class="co"># use the no-mask function</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create population dynamics object (without density dependence)</span></span>
<span><span class="va">popdyn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dynamics.html">dynamics</a></span><span class="op">(</span><span class="va">popmat</span>, <span class="va">envstoch</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate population dynamics</span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span></span>
<span>  <span class="va">popdyn</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>environmental_stochasticity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the population trajectories</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims</span>, col <span class="op">=</span> <span class="fu">alpha</span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="including_processes_files/figure-html/unnamed-chunk-19-1.png" class="r-plt" alt="Line plot showing 100 simulated trajectories initialised with the same initial conditions. Lines are variable due to environmental stochasticity and all decline consistently towards zero." width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jian Yen, Arthur Rylah Institute for Environmental Research.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
