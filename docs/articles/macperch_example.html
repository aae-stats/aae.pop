<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Population dynamics of Macquarie perch • aae.pop</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Population dynamics of Macquarie perch">
<meta property="og:description" content="aae.pop">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">aae.pop</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/get_started.html">get started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/including_processes.html">Including processes</a>
    </li>
    <li>
      <a href="../articles/beyond_defaults.html">Beyond defaults</a>
    </li>
    <li>
      <a href="../articles/metapopulations.html">Metapopulations</a>
    </li>
    <li>
      <a href="../articles/multiple_species.html">Multiple species</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/macperch_example.html">Macquarie perch</a>
    </li>
    <li>
      <a href="../articles/scenarios_example.html">Comparing scenarios</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">documentation</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/aae-stats/aae.pop">
    <span class="fab fa fab fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="macperch_example_files/htmlwidgets-1.5.1/htmlwidgets.js"></script><script src="macperch_example_files/viz-1.8.2/viz.js"></script><link href="macperch_example_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="macperch_example_files/grViz-binding-1.0.6.1/grViz.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Population dynamics of Macquarie perch</h1>
                        <h4 class="author">Jian Yen</h4>
            
            <h4 class="date">12/11/2020</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/aae-stats/aae.pop/blob/master/vignettes/macperch_example.Rmd"><code>vignettes/macperch_example.Rmd</code></a></small>
      <div class="hidden name"><code>macperch_example.Rmd</code></div>

    </div>

    
    
<div id="background" class="section level2">
<h2 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h2>
<p>This example uses a model of Macquarie perch (<em>Macquaria australasica</em>) population dynamics to illustrate several advanced features of <code>aae.pop</code>. Specifically, this example demonstrates the use of multiple <code>args</code> terms in <code>simulate</code>, complex forms of density dependence, and the use of the <code>args.fn</code> option in <code>simulate</code>, which supports dynamic arguments that depend on the state of the population at each time step.</p>
<p>Macquarie perch is a freshwater fish species native to the Murray-Darling Basin in south-eastern Australia. Macquarie perch is a large (up to 46 cm and 3.5 kg), long-lived (up to 30 years) species, and was historically abundant throughout the southern Murray-Darling Basin, supporting an important recreational fishery until the 1980s. Macquarie perch has since undergone a dramatic decline in range and abundance, to the point where it is now considered locally extinct across much of its former range, and is listed as a nationally endangered species.</p>
<p>The model outlined here includes age-specific survival and reproduction for 30 age classes as well as eggs and larvae. Survival and reproduction are density dependent and spawning success varies among years. This model includes the effects of variable flow conditions and allows individuals (adults or juveniles) to be added or removed from the population in any given year to simulate the effects of stocking or recreational fishing.</p>
</div>
<div id="building-a-population-model-for-macquarie-perch" class="section level2">
<h2 class="hasAnchor">
<a href="#building-a-population-model-for-macquarie-perch" class="anchor"></a>Building a population model for Macquarie perch</h2>
<div id="the-population-matrix" class="section level3">
<h3 class="hasAnchor">
<a href="#the-population-matrix" class="anchor"></a>The population matrix</h3>
<p>The population matrix is the most important part of a population dynamics model. The population matrix for Macquarie perch is substantially more complex than in other vignettes and examples. Notably, this matrix includes 30 age classes, with vital rates defined as functions of age.</p>
<p>Individuals become reproductively mature at 3-4 years, and fecundity increases with age <span class="citation">(Todd and Lintermans 2015)</span>. The age-fecundity relationship can be characterised with a three-parameter function (derived in <span class="citation">Todd and Lintermans (2015)</span>). This relationship is captured in the following R function:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co"># function to simulate reproductive output of Macquarie perch</span>
<span class="va">fecundity</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span>
  <span class="va">age</span>,                             <span class="co"># vector of ages</span>
  <span class="va">mean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.68</span>, <span class="op">-</span><span class="fl">0.302</span>, <span class="fl">2.886</span><span class="op">)</span>,   <span class="co"># mean parameters for fecundity function</span>
  <span class="va">early_surv</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.013</span>, <span class="fl">0.13</span><span class="op">)</span> <span class="co"># estimates of early life survival (eggs, larvae, young-of-year)</span>
<span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># mean estimates of three model parameters</span>
  <span class="va">y1</span> <span class="op">&lt;-</span> <span class="va">mean</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="va">y2</span> <span class="op">&lt;-</span> <span class="va">mean</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
  <span class="va">y3</span> <span class="op">&lt;-</span> <span class="va">mean</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
  
  <span class="co"># calculate fecundity</span>
  <span class="va">y2_term</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">y2</span> <span class="op">*</span> <span class="va">age</span><span class="op">)</span>
  <span class="va">y1_y2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">43.15</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span> <span class="va">y1</span> <span class="op">*</span> <span class="va">y2_term</span><span class="op">)</span><span class="op">)</span>
  <span class="va">fec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">2.295</span> <span class="op">*</span> <span class="va">y1_y2</span> <span class="op">+</span> <span class="va">y3</span><span class="op">)</span>

  <span class="co"># add early life survival and muliply by 0.5</span>
  <span class="co">#   to account for a 50:50 sex ratio</span>
  <span class="fl">0.5</span> <span class="op">*</span> <span class="va">fec</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/prod.html">prod</a></span><span class="op">(</span><span class="va">early_surv</span><span class="op">)</span>
  
<span class="op">}</span>

<span class="co"># plot mean fecundity as a function of age</span>
<span class="va">age_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">30</span>, length <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="fu">fecundity</span><span class="op">(</span><span class="va">age_vec</span><span class="op">)</span> <span class="op">~</span> <span class="va">age_vec</span>, las <span class="op">=</span> <span class="fl">1</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"Age"</span>, ylab <span class="op">=</span> <span class="st">"Fecundity"</span>, bty <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="macperch_example_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<p>Survival has a peaked relationship with age, increasing in individuals up to approximately 20 years of age and declining from that point onwards <span class="citation">(Todd and Lintermans 2015)</span>. This relationship is captured in the following parameters:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co"># define survival parameters</span>
<span class="va">survival_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fl">0.25</span>, <span class="fl">0.44</span>, <span class="fl">0.56</span>, <span class="fl">0.63</span>, <span class="fl">0.69</span>, <span class="fl">0.72</span>, <span class="fl">0.75</span>, <span class="fl">0.78</span>, <span class="fl">0.79</span>,
  <span class="fl">0.81</span>, <span class="fl">0.82</span>, <span class="fl">0.83</span>, <span class="fl">0.83</span>, <span class="fl">0.84</span>, <span class="fl">0.84</span>, <span class="fl">0.84</span>, <span class="fl">0.85</span>, <span class="fl">0.85</span>, <span class="fl">0.84</span>,
  <span class="fl">0.84</span>, <span class="fl">0.84</span>, <span class="fl">0.83</span>, <span class="fl">0.82</span>, <span class="fl">0.80</span>, <span class="fl">0.78</span>, <span class="fl">0.76</span>, <span class="fl">0.71</span>, <span class="fl">0.63</span>, <span class="fl">0.48</span>
<span class="op">)</span>

<span class="co"># plot mean survival as a function of age</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">survival_params</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">29</span><span class="op">)</span>, las <span class="op">=</span> <span class="fl">1</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"Age"</span>, ylab <span class="op">=</span> <span class="st">"Survival"</span>, bty <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="macperch_example_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>These values are sufficient to construct the (mean) population matrix:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="co"># define population matrix</span>
<span class="va">nclass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">survival_params</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>
<span class="va">popmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">nclass</span>, ncol <span class="op">=</span> <span class="va">nclass</span><span class="op">)</span>
<span class="va">popmat</span><span class="op">[</span><span class="fu"><a href="../reference/masks.html">transition</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">survival_params</span>
<span class="va">popmat</span><span class="op">[</span><span class="fu"><a href="../reference/masks.html">reproduction</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">fecundity</span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span>

<span class="co"># convert this to a dynamics object and plot it</span>
<span class="va">popdyn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dynamics.html">dynamics</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">popdyn</span><span class="op">)</span></pre></div>
<div id="htmlwidget-208be82ad30516a0c626" style="width:700px;height:432.632880098888px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-208be82ad30516a0c626">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       rankdir = \"LR\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"circle\",\n      fixedsize = \"true\",\n      width = \"0.5\",\n      style = \"filled\",\n      fillcolor = \"aliceblue\",\n      color = \"gray70\",\n      fontcolor = \"gray50\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray80\",\n     arrowsize = \"0.5\"]\n\n  \"1\" [label = \"Age 1\", fontcolor = \"#4F7942\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#4F7942\", width = \"0.9\", height = \"0.72\", fillcolor = \"#4F794250\"] \n  \"2\" [label = \"Age 2\", fontcolor = \"#4F7942\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#4F7942\", width = \"0.9\", height = \"0.72\", fillcolor = \"#4F794250\"] \n  \"3\" [label = \"Age 3\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"4\" [label = \"Age 4\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"5\" [label = \"Age 5\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"6\" [label = \"Age 6\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"7\" [label = \"Age 7\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"8\" [label = \"Age 8\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"9\" [label = \"Age 9\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"10\" [label = \"Age 10\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"11\" [label = \"Age 11\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"12\" [label = \"Age 12\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"13\" [label = \"Age 13\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"14\" [label = \"Age 14\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"15\" [label = \"Age 15\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"16\" [label = \"Age 16\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"17\" [label = \"Age 17\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"18\" [label = \"Age 18\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"19\" [label = \"Age 19\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"20\" [label = \"Age 20\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"21\" [label = \"Age 21\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"22\" [label = \"Age 22\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"23\" [label = \"Age 23\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"24\" [label = \"Age 24\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"25\" [label = \"Age 25\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"26\" [label = \"Age 26\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"27\" [label = \"Age 27\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"28\" [label = \"Age 28\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"29\" [label = \"Age 29\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n  \"30\" [label = \"Age 30\", fontcolor = \"#0E4D92\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#0E4D92\", width = \"0.9\", height = \"0.72\", fillcolor = \"#0E4D9250\"] \n\"1\"->\"2\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"2\"->\"3\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"3\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"3\"->\"4\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"4\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"4\"->\"5\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"5\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"5\"->\"6\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"6\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"6\"->\"7\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"7\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"7\"->\"8\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"8\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"8\"->\"9\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"9\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"9\"->\"10\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"10\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"10\"->\"11\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"11\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"11\"->\"12\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"12\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"12\"->\"13\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"13\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"13\"->\"14\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"14\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"14\"->\"15\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"15\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"15\"->\"16\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"16\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"16\"->\"17\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"17\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"17\"->\"18\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"18\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"18\"->\"19\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"19\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"19\"->\"20\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"20\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"20\"->\"21\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"21\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"21\"->\"22\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"22\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"22\"->\"23\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"23\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"23\"->\"24\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"24\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"24\"->\"25\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"25\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"25\"->\"26\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"26\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"26\"->\"27\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"27\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"27\"->\"28\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"28\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"28\"->\"29\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"29\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n\"29\"->\"30\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"transition\", style = \"solid\"] \n\"30\"->\"1\" [color = \"Gainsboro\", fontname = \"Avenir\", fontcolor = \"LightGray\", fontsize = \"14\", penwidth = \"4\", label = \"fecundity\", style = \"dashed\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script><p>This population matrix is much more complex than the examples in the <a href="get_started.html">Getting started</a> vignette, yet this form only supports deterministic projections of Macquarie perch populations with constant vital rates and no other processes operating (e.g., density dependence). The following sections add several additional processes to create a more-complete model of Macquarie perch population dynamics.</p>
</div>
<div id="density-dependence" class="section level3">
<h3 class="hasAnchor">
<a href="#density-dependence" class="anchor"></a>Density dependence</h3>
<p>Density dependence is introduced in the <a href="including_processes.html">Including processes</a> vignette. Macquarie perch present an interesting case study, where density dependence operates on both reproduction, through an Allee effect or positive density dependence, and on survival, through a negative, top-down effect of competitive interactions for habitat <span class="citation">(Todd and Lintermans 2015)</span>. These effects can be captured with the following R functions:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="co"># masks: survival and reproduction of 3-30 year olds</span>
<span class="va">density_masks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/masks.html">transition</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/masks.html">reproduction</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># top-down effects of competition for habitat,</span>
<span class="co">#    arbitrary carrying capacity of 1000 here</span>
<span class="co">#    (could be passed as an arg)</span>
<span class="va">topdown_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">pop</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">sum_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pop</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">sum_n</span> <span class="op">&gt;</span> <span class="fl">1000</span>, <span class="fl">1000</span> <span class="op">/</span> <span class="va">sum_n</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">mat</span>
<span class="op">}</span>

<span class="co"># positive density dependence (Allee effect)</span>
<span class="va">allee_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">pop</span>, <span class="va">allee_strength</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">allee_factor</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">sum_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pop</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span><span class="op">)</span>
  <span class="va">allee</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">sum_n</span> <span class="op">/</span> <span class="op">(</span><span class="va">allee_strength</span> <span class="op">*</span> <span class="va">allee_factor</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>
  <span class="va">mat</span> <span class="op">&lt;-</span> <span class="va">allee</span> <span class="op">*</span> <span class="va">mat</span>
  <span class="va">mat</span>
<span class="op">}</span>

<span class="co"># combine the functions into a list</span>
<span class="va">density_fns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="va">topdown_fn</span>,
  <span class="va">allee_fn</span>
<span class="op">)</span>

<span class="co"># and collate masks and functions in a single object</span>
<span class="va">dens_depend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/density_dependence.html">density_dependence</a></span><span class="op">(</span>
  masks <span class="op">=</span> <span class="va">density_masks</span>,
  funs <span class="op">=</span> <span class="va">density_fns</span>
<span class="op">)</span></pre></div>
<p>The above functions both include <code>...</code> arguments that are not used in the functions themselves. This is necessary when non-standard arguments are passed to <code>simulate</code> for a given demographic process. In this case, the <code>allee_strength</code> and <code>allee_factor</code> arguments can (optionally) be set directly in a call to <code>simulate</code>, which would pass these arguments to all functions included in the <code>density_dependence</code> object. Without the <code>...</code> arguments, this would break <code>topdown_fn</code> because it cannot use the <code>allee_strength</code> or <code>allee_factor</code> terms. The <code>...</code> argument absorbs these extra terms. Although not required in <code>allee_fn</code>, adding <code>...</code> in this way can be a useful safeguard for models that may be updated in the future.</p>
</div>
<div id="environmental-stochasticity" class="section level3">
<h3 class="hasAnchor">
<a href="#environmental-stochasticity" class="anchor"></a>Environmental stochasticity</h3>
<p>The population matrix and density dependence defined above are entirely deterministic. This section will add environmental stochasticity to the population matrix, demonstrating the relatively slow <code>rmultiunit</code> function and a trick with the <code>args.fn</code> option to speed up <code>simulate</code> in this situation.</p>
<div id="aside-why-use-a-slow-function" class="section level4">
<h4 class="hasAnchor">
<a href="#aside-why-use-a-slow-function" class="anchor"></a>Aside: why use a slow function?</h4>
<p>The <code>runit</code> and <code>rmultiunit</code> functions are included in <code>aae.pop</code> to handle situations where stochastic values are required on the unit or [0, 1] interval. There are many ways to simulate values in this interval but commonly used methods do not return values with a known mean, standard deviation, or correlation structure (in the multivariate case). The solution to this involves solving several relatively messy equations to identify transformed means and standard deviations on the real line (i.e., between negative and positive infinity), generating random Normal variates, and converting these back to the unit interval with a cumulative distribution transform. The <code>rmultiunit</code> function does this but is not fast. This is a focus of future development in <code>aae.pop</code>, likely requiring a function written in C++ or similar, low-level language.</p>
<p>The <code>runit</code> function can be used as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="co"># generate 10 random values on the unit line (between 0 and 1) with known mean and sd</span>
<span class="fu"><a href="../reference/rng.html">runit</a></span><span class="op">(</span><span class="fl">10</span>, mean <span class="op">=</span> <span class="fl">0.25</span>, sd <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></pre></div>
<pre><code>##  [1] 0.33559412 0.01354525 0.07060994 0.10812194 0.93479295 0.13492053
##  [7] 0.04424263 0.03453046 0.45130256 0.06727675</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="co"># repeat this, but increase the standard deviation, noting the values still sit in [0, 1]</span>
<span class="fu"><a href="../reference/rng.html">runit</a></span><span class="op">(</span><span class="fl">10</span>, mean <span class="op">=</span> <span class="fl">0.25</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></pre></div>
<pre><code>##  [1] 1 1 0 0 1 0 0 0 1 0</code></pre>
<p><code>rmultiunit</code> is similar to <code>runit</code> but generates multivariate outcomes, i.e., vectors of values. In this case, the mean and sd are vectors and the replicates determine the number of vectors to be simulated. This approach can also include correlation structure in the simulated values, although this level of detail is unusual in practice due to a lack of information on empirical correlations:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="co"># generate 10 random vectors of 5 values each, on the unit line</span>
<span class="fu"><a href="../reference/rng.html">rmultiunit</a></span><span class="op">(</span><span class="fl">10</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="fl">0.6</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>##            [,1]      [,2]       [,3]      [,4]      [,5]
##  [1,] 0.3939735 0.2853072 0.09409237 0.8623073 0.9161126
##  [2,] 0.5179323 0.2072803 0.12986126 0.9697224 0.6058093
##  [3,] 0.3497532 0.2235739 0.11628360 0.9473978 0.5139187
##  [4,] 0.5397205 0.2003411 0.07281396 0.9052345 0.6676988
##  [5,] 0.3673924 0.1806111 0.05012865 0.9540447 0.6912178
##  [6,] 0.6221911 0.1348598 0.14532454 0.8574427 0.7846602
##  [7,] 0.3972538 0.2597779 0.06548694 0.8972685 0.5561895
##  [8,] 0.4790801 0.2144535 0.11066527 0.9337883 0.6661865
##  [9,] 0.4443096 0.1740153 0.13321791 0.9485680 0.6514108
## [10,] 0.5513246 0.2261484 0.07990790 0.9118337 0.7492187</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="co"># repeat this, but with a known correlation structure</span>
<span class="va">omega_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,    <span class="fl">0</span>,    <span class="fl">0.15</span>, <span class="fl">0</span>,    <span class="fl">0</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,    <span class="fl">1</span>,    <span class="fl">0</span>,    <span class="fl">0.75</span>, <span class="fl">0</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0</span>,    <span class="fl">1</span>,    <span class="fl">0</span>,    <span class="fl">0.25</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,    <span class="fl">0.75</span>, <span class="fl">0</span>,    <span class="fl">1</span>,    <span class="fl">0</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">0.25</span>, <span class="fl">0</span>,    <span class="fl">1</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">unit_sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rng.html">rmultiunit</a></span><span class="op">(</span>
  <span class="fl">10000</span>, 
  mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="fl">0.6</span><span class="op">)</span>, 
  sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.2</span><span class="op">)</span>, 
  Omega <span class="op">=</span> <span class="va">omega_est</span>
<span class="op">)</span></pre></div>
<p>It is easy to verify that <code>runit</code> and <code>rmultiunit</code> return values with approximately correct means, standard deviations, and correlations. For the final example above, the means are:</p>
<pre><code>## [1] 0.5 0.2 0.1 0.9 0.6</code></pre>
<p>and the standard deviations are:</p>
<pre><code>## [1] 0.10 0.05 0.05 0.05 0.20</code></pre>
<p>Last, the correlations are:</p>
<pre><code>##      [,1] [,2] [,3] [,4] [,5]
## [1,] 1.00 0.00 0.15 0.00 0.00
## [2,] 0.00 1.00 0.00 0.75 0.01
## [3,] 0.15 0.00 1.00 0.00 0.25
## [4,] 0.00 0.75 0.00 1.00 0.00
## [5,] 0.00 0.01 0.25 0.00 1.00</code></pre>
<p>Although these values do not match perfectly, they are close and will match increasingly well with more samples.</p>
</div>
<div id="back-to-environmental-stochasticity" class="section level4">
<h4 class="hasAnchor">
<a href="#back-to-environmental-stochasticity" class="anchor"></a>Back to environmental stochasticity</h4>
<p>Forging ahead with the <code>rmultiunit</code> approach, this section will use a related function (<code>rmultiunit_from_real</code>) that includes only part of the <code>rmultiunit</code> calculation. This function takes pre-transformed estimates of the mean and standard deviation, which removes the slowest step from the <code>rmultiunit</code> calculation. This is possible because the mean vital rates only change once per time step (or not at all if covariates are not included), and all other changes to these rates (e.g., density dependence) occur <em>after</em> incorporating environmental stochasticity. Therefore, the conversion of means and standard deviations to the real line can occur once per time step rather than for every single replicate within each time step.</p>
<p>The first step is to define functions to use within an <code>environmental_stochasticity</code> process. These functions will assume means and standard deviations are already converted to their real-line equivalents; this conversion and its use in <code>simulate</code> will be covered below. As introduced in the <a href="including_processes.html">Including processes</a> vignette, the <code>environmental_stochasticity</code> process adds variation to vital rates through a combination of masks and functions:</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="co"># define masks for environmental stochasticity</span>
<span class="va">envstoch_masks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/masks.html">transition</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span>,                 <span class="co"># all survival estimates</span>
  <span class="fu"><a href="../reference/masks.html">reproduction</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span>   <span class="co"># reproduction from all adults</span>
<span class="op">)</span>

<span class="co"># define a survival function, adding dots to soak up extra arguments within simulate</span>
<span class="va">survival_gen</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">mean_real</span>, <span class="va">sd_real</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../reference/rng.html">rmultiunit_from_real</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, mean_real <span class="op">=</span> <span class="va">mean_real</span>, sd_real <span class="op">=</span> <span class="va">sd_real</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># define a reproduction function, being careful with argument names to avoid conflicts</span>
<span class="co">#   with any arguments in survival_gen, which would then require multiple different</span>
<span class="co">#   arguments with the same name in simulate</span>
<span class="va">reproduction_gen</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span>
  <span class="va">mat</span>,
  <span class="va">fec_mean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.68</span>, <span class="op">-</span><span class="fl">0.302</span>, <span class="fl">2.886</span><span class="op">)</span>,
  <span class="va">fec_sd</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="fl">0.15</span><span class="op">)</span>,
  <span class="va">early_mean</span>,
  <span class="va">early_sd</span>, 
  <span class="va">...</span>
<span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># need a vector of ages, hard coded here (could be an argument)</span>
  <span class="va">age</span> <span class="op">&lt;-</span> <span class="fl">3</span><span class="op">:</span><span class="fl">30</span>
  
  <span class="co"># generate stochastic values for early life survival (eggs, larvae, young-of-year)</span>
  <span class="va">early_real</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rng.html">rmultiunit_from_real</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, mean <span class="op">=</span> <span class="va">early_mean</span>, sd <span class="op">=</span> <span class="va">early_sd</span><span class="op">)</span>
  
  <span class="co"># otherwise draw random variates for the three model parameters</span>
  <span class="va">y1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, mean <span class="op">=</span> <span class="va">fec_mean</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, sd <span class="op">=</span> <span class="va">fec_sd</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
  <span class="va">y2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, mean <span class="op">=</span> <span class="va">fec_mean</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, sd <span class="op">=</span> <span class="va">fec_sd</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
  <span class="va">y3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, mean <span class="op">=</span> <span class="va">fec_mean</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, sd <span class="op">=</span> <span class="va">fec_sd</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>
  
  <span class="co"># generate reproduction estimates for all adult age classes, incorporating</span>
  <span class="co">#   stochastic early life estimates</span>
  <span class="va">y2_term</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">y2</span> <span class="op">%o%</span> <span class="va">age</span><span class="op">)</span>
  <span class="va">y1_y2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span>
    <span class="fl">43.15</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span><span class="op">(</span><span class="va">y2_term</span>, <span class="fl">1</span>, <span class="op">-</span><span class="va">y1</span>, <span class="st">"*"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="va">reprod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span><span class="op">(</span><span class="fl">2.295</span> <span class="op">*</span> <span class="va">y1_y2</span>, <span class="fl">1</span>, <span class="va">y3</span>, <span class="st">"+"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># add early life survival and muliply by 0.5</span>
  <span class="co">#   to account for a 50:50 sex ratio</span>
  <span class="fl">0.5</span> <span class="op">*</span> <span class="va">reprod</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/prod.html">prod</a></span><span class="op">(</span><span class="va">early_real</span><span class="op">)</span>

<span class="op">}</span>

<span class="co"># combine masks and functions into a single object</span>
<span class="va">envstoch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stochasticity.html">environmental_stochasticity</a></span><span class="op">(</span>
  masks <span class="op">=</span> <span class="va">envstoch_masks</span>,
  funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">survival_gen</span>, <span class="va">reproduction_gen</span><span class="op">)</span>
<span class="op">)</span></pre></div>
<p>The conversion of means and standard deviations from the unit interval to real-line equivalents is supported by the <code>unit_to_real</code> function. This function can be wrapped up and passed to <code>simulate</code> with the <code>args.fn</code> option. This option allows functions to define the arguments to demographic processes based on three inputs: the population <code>dynamics</code> object, the state of the population at a given time step, and the iteration index (i.e., the current year or generation). An alternative approach is to use the <code>args.dyn</code> option, which takes a <code>list</code> of arguments, with one element for each time step.</p>
<p>In this example, <code>args.fn</code> requires a function that takes the survival estimates (on the unit interval) and converts these to their real-line equivalents. This conversion requires information on the standard deviations, as well as survival estimates for early life stages (eggs, larvae, young-of-year):</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="va">transform_survival</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">pop</span>, <span class="va">iter</span><span class="op">)</span> <span class="op">{</span>

  <span class="co"># pull out the population matrix in the current time step</span>
  <span class="va">mat</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="va">matrix</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span>
    <span class="va">mat</span> <span class="op">&lt;-</span> <span class="va">mat</span><span class="op">[[</span><span class="va">iter</span><span class="op">]</span><span class="op">]</span>

  <span class="co"># wrap up all survival means and SDs, including early life</span>
  <span class="co">#  (this allows a single call to `unit_to_real`, which is slow)</span>
  <span class="va">survival_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="fl">0.5</span>, <span class="fl">0.013</span>, <span class="fl">0.13</span>,     <span class="co"># early life</span>
    <span class="va">mat</span><span class="op">[</span><span class="fu"><a href="../reference/masks.html">transition</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">]</span>  <span class="co"># from population matrix in current time step</span>
  <span class="op">)</span>
  <span class="va">survival_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="fl">0.1</span>, <span class="fl">0.007</span>, <span class="fl">0.028</span>,  <span class="co"># early life</span>
    <span class="fl">0.05</span>, <span class="fl">0.09</span>, <span class="fl">0.11</span>, <span class="fl">0.10</span>, <span class="fl">0.10</span>, <span class="fl">0.07</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>,
    <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>,
    <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.07</span>, <span class="fl">0.06</span>, <span class="fl">0.05</span>
  <span class="op">)</span>

  <span class="co"># convert unit interval to real line equivalents</span>
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rng.html">unit_to_real</a></span><span class="op">(</span>
    unit_mean <span class="op">=</span> <span class="va">survival_mean</span>,
    unit_sd <span class="op">=</span> <span class="va">survival_sd</span>
  <span class="op">)</span>
  
  <span class="co"># separate early life from other estimates</span>
  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">3</span>

  <span class="co"># return</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean_real <span class="op">=</span> <span class="va">out</span><span class="op">[</span><span class="va">idx</span>, <span class="fl">1</span><span class="op">]</span>,    <span class="co"># for survival_gen</span>
       sd_real <span class="op">=</span> <span class="va">out</span><span class="op">[</span><span class="va">idx</span>, <span class="fl">2</span><span class="op">]</span>,      <span class="co"># for survival_gen</span>
       early_mean <span class="op">=</span> <span class="va">out</span><span class="op">[</span><span class="op">!</span><span class="va">idx</span>, <span class="fl">1</span><span class="op">]</span>,  <span class="co"># for reproduction_gen</span>
       early_sd <span class="op">=</span> <span class="va">out</span><span class="op">[</span><span class="op">!</span><span class="va">idx</span>, <span class="fl">2</span><span class="op">]</span>     <span class="co"># for reproduction_gen</span>
  <span class="op">)</span>
  
<span class="op">}</span></pre></div>
</div>
</div>
<div id="adding-and-removing-individuals" class="section level3">
<h3 class="hasAnchor">
<a href="#adding-and-removing-individuals" class="anchor"></a>Adding and removing individuals</h3>
<p>An additional process in the model of Macquarie perch population dynamics is the inclusion of stocking or fishing. These processes could be included directly in the population matrix through their effects on survival and reproduction. This section demonstrates an alternative way of accounting for the addition or removal of individuals, using the <code>density_dependence_n</code> construct, which allows density-dependent changes to the population vector (i.e., abundances) following all other updates. This approach requires a <code>mask</code> that selects the classes of the population affected, as well as a <code>function</code> that determines how population abundances are altered.</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="co"># take a population vector and update it to add or remove n individuals</span>
<span class="co">#   split into two stages (juveniles, adults)</span>
<span class="va">dd_n</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pop</span>, <span class="va">n</span>, <span class="va">add</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># are we removing individuals?</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">add</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="co"># check that there are enough juveniles</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pop</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">n</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pop</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
      <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"removing more juveniles than available;"</span>,
              <span class="st">" total removals reduced to "</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pop</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,
              call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="co"># check that there are enough adults</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pop</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">n</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pop</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span><span class="op">)</span>
      <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"removing more adults than available;"</span>,
              <span class="st">" total removals reduced to "</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pop</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span><span class="op">)</span>,
              call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="co"># expand n to remove from random age classes</span>
    <span class="va">n_juvenile_by_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, times <span class="op">=</span> <span class="va">pop</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
    <span class="va">juvenile_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">n_juvenile_by_age</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">n</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, replace <span class="op">=</span> <span class="cn">FALSE</span>
    <span class="op">)</span>
    <span class="va">n_juvenile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">n_juvenile_by_age</span><span class="op">[</span><span class="va">juvenile_idx</span><span class="op">]</span><span class="op">)</span>
    <span class="va">n_adult_by_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">30</span>, times <span class="op">=</span> <span class="va">pop</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span><span class="op">)</span>
    <span class="va">adult_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">n_adult_by_age</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">n</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, replace <span class="op">=</span> <span class="cn">FALSE</span>
    <span class="op">)</span>
    <span class="va">n_adult</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">n_adult_by_age</span><span class="op">[</span><span class="va">adult_idx</span><span class="op">]</span><span class="op">)</span>
    
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    
    <span class="co"># sample random classes to add individuals</span>
    <span class="va">n_juvenile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, size <span class="op">=</span> <span class="va">n</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">)</span>
    <span class="va">n_adult</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">30</span>, size <span class="op">=</span> <span class="va">n</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">)</span>
    
  <span class="op">}</span>
  
  <span class="co"># convert from a vector of classes to a count for each class</span>
  <span class="va">n_juvenile_expanded</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">n_juvenile_expanded</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>
  <span class="va">n_juvenile_expanded</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">n_juvenile</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">n_juvenile</span>
  <span class="va">n_adult_expanded</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">28</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">n_adult_expanded</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span>
  <span class="va">n_adult_expanded</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">n_adult</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">n_adult</span>
  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n_juvenile_expanded</span>, <span class="va">n_adult_expanded</span><span class="op">)</span>

  <span class="co"># adding is the opposite of removing</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">add</span><span class="op">)</span>
    <span class="va">n</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">n</span>
  
  <span class="co"># update pop abundances and return</span>
  <span class="va">pop</span> <span class="op">-</span> <span class="va">n</span>
  
<span class="op">}</span>

<span class="co"># wrap this up in a density_dependence_n object</span>
<span class="va">dens_depend_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/density_dependence.html">density_dependence_n</a></span><span class="op">(</span>
  masks <span class="op">=</span> <span class="fu"><a href="../reference/masks.html">all_classes</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span>,
  funs <span class="op">=</span> <span class="va">dd_n</span>
<span class="op">)</span></pre></div>
<p>The <code>dd_n</code> function above is entirely deterministic and static, that is, a fixed number of individuals is added or removed each and every time step. An extension of this approach could set the number of individuals stochastically (e.g., as a Poisson random variable) and could make the number of individuals change through time. For example, the <code>args.fn</code> or <code>args.dyn</code> options could pass a time-varying value of <code>n</code>, or the <code>dd_n</code> function could use <code>pop</code> (actual abundances) to define a density-dependent addition or removal scenario. These extensions are not shown here but an example of the <code>args.fn</code> approach is included in the <code>macquarie_perch</code> template to simulate changes in fishing regulations or stocking through time.</p>
</div>
<div id="covariate-effects" class="section level3">
<h3 class="hasAnchor">
<a href="#covariate-effects" class="anchor"></a>Covariate effects</h3>
<p>The final demographic process included in the Macquarie perch population model is (deterministic) covariate effects on vital rates. The definition of these effects assumes that the vital rates shown above are <em>maximum</em> values, with covariates reducing survival or recruitment relative to these maximum values. Covariates are included for four patterns observed in Macquarie perch in Lake Dartmouth:</p>
<ul>
<li><p>Recruitment of young individuals has a peaked relationship with discharge in November and December. Recruitment is reduced if discharge is below 50 % or above 100 % of the long-term average in this period.</p></li>
<li><p>Recruitment is reduced if discharge is highly variable during November and December.</p></li>
<li><p>Recruitment is reduced if lake level is increased substantially relative to the previous year.</p></li>
<li><p>Adult survival is reduced if discharge into the lake drops below 100 % of the long-term average.</p></li>
</ul>
<p>Several of these effects relate to river discharge rather than lake conditions because adults from this population move from the lake into the adjacent river channel to spawn.</p>
<p>These covariate effects can be captured with the following masks and functions:</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="co"># effect 1: recruitment has peaked association with Nov/Dec discharge</span>
<span class="va">recruit_peaked</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># define a quadratic association with log-transformed discharge</span>
  <span class="va">log_discharge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">spawning_discharge</span> <span class="op">+</span> <span class="fl">0.01</span><span class="op">)</span>
  <span class="va">scale_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">log_discharge</span> <span class="op">-</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="op">(</span><span class="va">log_discharge</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># make sure values are in the [0, 1] range</span>
  <span class="va">scale_factor</span><span class="op">[</span><span class="va">scale_factor</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>
  <span class="va">scale_factor</span><span class="op">[</span><span class="va">scale_factor</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
  
  <span class="co"># return re-scaled recruitment values</span>
  <span class="va">mat</span> <span class="op">*</span> <span class="va">scale_factor</span>

<span class="op">}</span>

<span class="co"># effect 2: recruitment reduced in variable Nov/Dec conditions</span>
<span class="va">recruit_variability</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">mat</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.05</span> <span class="op">*</span> <span class="va">x</span><span class="op">$</span><span class="va">spawning_variability</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># effect 3: recruitment reduced with rising lake level</span>
<span class="va">recruit_level</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">mat</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">water_level_change</span> <span class="op">+</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># effect 4: adult survival reduced by low-discharge conditions</span>
<span class="va">adult_low</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>

  <span class="co"># define a quadratic association with log-transformed discharge  </span>
  <span class="va">log_discharge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">average_daily_discharge</span> <span class="op">+</span> <span class="fl">0.01</span><span class="op">)</span>
  <span class="va">scale_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">0.3</span> <span class="op">*</span> <span class="va">log_discharge</span> <span class="op">-</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="op">(</span><span class="va">log_discharge</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># make sure values are in the [0, 1] range</span>
  <span class="va">scale_factor</span><span class="op">[</span><span class="va">scale_factor</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>
  <span class="va">scale_factor</span><span class="op">[</span><span class="va">scale_factor</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
  
  <span class="co"># return re-scaled survival values</span>
  <span class="va">mat</span> <span class="op">*</span> <span class="va">scale_factor</span>

<span class="op">}</span>

<span class="co"># define masks</span>
<span class="va">covar_masks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/masks.html">reproduction</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/masks.html">reproduction</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/masks.html">reproduction</a></span><span class="op">(</span><span class="va">popmat</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/masks.html">transition</a></span><span class="op">(</span><span class="va">popmat</span>, dims <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># link functions to masks</span>
<span class="va">covar_funs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="va">recruit_peaked</span>,
  <span class="va">recruit_variability</span>,
  <span class="va">recruit_level</span>,
  <span class="va">adult_low</span>
<span class="op">)</span>

<span class="co"># collate into a single object</span>
<span class="va">covars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/covariates.html">covariates</a></span><span class="op">(</span>
  masks <span class="op">=</span> <span class="va">covar_masks</span>,
  funs <span class="op">=</span> <span class="va">covar_funs</span>
<span class="op">)</span></pre></div>
<p>The three recruitment effects all share the same mask, so there is no reason they could not be included in a single function. Separating these effects is useful because it allows effects to be added or removed easily without editing the underlying functions.</p>
<p>All four functions also share the same input covariate, <code>x</code>, with subsetting occurring within the functions using R’s <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> subsetting approach. This requires that <code>x</code> is passed as a <code>data.frame</code> with column names matching those used in the functions (<code>spawning_discharge</code>, <code>spawning_variability</code>, <code>water_level_change</code>, <code>average_daily_discharge</code>). The definition and inclusion of covariates in <code>simulate</code> is shown in the following section.</p>
</div>
</div>
<div id="simulating-population-dynamics" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-population-dynamics" class="anchor"></a>Simulating population dynamics</h2>
<p>With demographic processes defined, it is straightforward to define a <code>dynamics</code> object. Here, we can simply update the <code>dynamics</code> object defined earlier:</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="co"># update previously defined population dynamics object</span>
<span class="co">#   (which only included popmat)</span>
<span class="va">popdyn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span>
  <span class="va">popdyn</span>,
  <span class="va">covars</span>,
  <span class="va">envstoch</span>,
  <span class="va">dens_depend</span>,
  <span class="va">dens_depend_n</span>
<span class="op">)</span></pre></div>
<p>Simulating from this object requires a call to <code>simulate</code>, also recalling that at least one <code>args.fn</code> is required here to transform survival values from the unit interval to their real-line equivalents:</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="co"># simulate, using the transform_survival function defined above</span>
<span class="co">#   to update arguments passed to environmental_stochasticity and</span>
<span class="co">#   adding arguments to specify 100 juveniles and 10 adults</span>
<span class="co">#   removed per time step (e.g., due to fishing)</span>
<span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span>
  <span class="va">popdyn</span>,
  nsim <span class="op">=</span> <span class="fl">100</span>,
  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>density_dependence_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,
  args.fn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>environmental_stochasticity <span class="op">=</span> <span class="va">transform_survival</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># plot the simulated trajectories</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">sims</span>, col <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="macperch_example_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>The simulated abundances are extremely high given expected population sizes in this system. The primary reason for this is that the model assumes <em>ideal</em> conditions in each year, with covariate effects used to reduce vital rates to match actual conditions. Covariates can be added to this model with the following code, noting that the same <code>popdyn</code> object can be used with or without covariates:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="co"># simulate 30 years of covariate values based on ranges in</span>
<span class="co">#   actual discharge data (covariates and functions</span>
<span class="co">#   are defined based on standardised flow values)</span>
<span class="va">covar_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  spawning_discharge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">30</span>, min <span class="op">=</span> <span class="fl">0.5</span>, max <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,
  spawning_variability <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">30</span>, min <span class="op">=</span> <span class="fl">0.3</span>, max <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,
  water_level_change <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="fl">30</span>, lambda <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
  average_daily_discharge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">30</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># simulate</span>
<span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate.html">simulate</a></span><span class="op">(</span>
  <span class="va">popdyn</span>, 
  nsim <span class="op">=</span> <span class="fl">100</span>, 
  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    density_dependence_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,        <span class="co"># remove no individuals this time</span>
    covariates <span class="op">=</span> <span class="fu"><a href="../reference/covariates.html">format_covariates</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">covar_values</span><span class="op">)</span> <span class="co"># pass formatted covariate values</span>
  <span class="op">)</span>,
  args.fn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>environmental_stochasticity <span class="op">=</span> <span class="va">transform_survival</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># plot the simulated trajectories</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">sims</span>, col <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="macperch_example_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>The simulated trajectories now look much more realistic. Here, large values reflect young individuals, many of which do not survive to adulthood. Plotting older classes alone highlights this effect:</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="co"># all adults</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">sims</span>, subset <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="macperch_example_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="co"># ages 5 and above</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">sims</span>, subset <span class="op">=</span> <span class="fl">5</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="macperch_example_files/figure-html/unnamed-chunk-17-2.png" width="700"></p>
</div>
<div id="summarising-model-outputs" class="section level2">
<h2 class="hasAnchor">
<a href="#summarising-model-outputs" class="anchor"></a>Summarising model outputs</h2>
<p>The model developed here can be used to forecast Macquarie perch population dynamics on any time scale (e.g., years, decades). One application is the generation of accurate predictions of population dynamics on relatively short time scales (1 or 2 years). Generating accurate predictions is challenging, even on short timescales, and requires reliable estimates of initial conditions and future covariates. Applications of this type can use the direct outputs of a simulation, using replicate trajectories to characterise the distribution of possible states on short time scales.</p>
<p>An alternative application is the comparison of hypothetical scenarios on longer time scales. This approach emphasises <em>relative</em> changes in population size or structure, with accuracy less important than relative differences among scenarios. Applications of this type require summaries of population trajectories over long time scales. Examples of these summaries include extinction or quasi-extinction risk, minimum observed population size, or effective population size if appropriate genetic information is available. This section will demonstrate calculations of several of these metrics, noting that bespoke metrics will be applicable in many situations.</p>
<p>A common and simple summary metric is extinction or quasi-extinction risk, which is the probability a population will fall to zero individuals (extinction) or below a specified threshold (quasi-extinction). This example will focus on quasi-extinction because it is more general. The rationale behind quasi-extinction is that, below some threshold, the population will be unable to recover sufficiently to be viable in the future. The threshold is typically assumed to reflect the point at which inbreeding becomes prevalent. In population modelling terms, quasi-extinction risk is the proportion of replicate trajectories that fall below a given threshold at any time step. This can be calculated with the following function:</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="co"># calculate proportion of trajectories falling below a given threshold</span>
<span class="co">#   in any time step. By default, all population classes are included</span>
<span class="co">#   but `subset` can be used to select specific classes</span>
<span class="va">calculate_quasi_extinction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">popsim</span>, <span class="va">threshold</span>, <span class="va">subset</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">include</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># is a subset required?</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">subset</span><span class="op">)</span><span class="op">)</span>
    <span class="va">popsim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">popsim</span>, subset <span class="op">=</span> <span class="va">subset</span><span class="op">)</span>
  
  <span class="co"># sum population abundances over all remaining classes</span>
  <span class="va">popsim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">popsim</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span>
  
  <span class="co"># do we want to include the threshold value in the check?</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">include</span><span class="op">)</span>
    <span class="va">threshold</span> <span class="op">&lt;-</span> <span class="va">threshold</span> <span class="op">+</span> <span class="fl">1e-5</span>
  
  <span class="co"># is a trajectory below a threshold?</span>
  <span class="va">threshold_check</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">popsim</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;</span> <span class="va">threshold</span><span class="op">)</span>
  
  <span class="co"># return proportion below threshold</span>
  <span class="co">#   (mean of binary values is the proportion equal to 1)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">threshold_check</span><span class="op">)</span>
  
<span class="op">}</span></pre></div>
<p>This function can be used to explore many different outputs:</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="co"># probability of 10 or fewer adults</span>
<span class="fu">calculate_quasi_extinction</span><span class="op">(</span><span class="va">sims</span>, threshold <span class="op">=</span> <span class="fl">10</span>, subset <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">30</span>, include <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<pre><code>## [1] 0.03612903</code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit">
<span class="co"># probability of 1000 or fewer individuals</span>
<span class="fu">calculate_quasi_extinction</span><span class="op">(</span><span class="va">sims</span>, threshold <span class="op">=</span> <span class="fl">1000</span>, include <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<pre><code>## [1] 0.06290323</code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit">
<span class="co"># probability of extinction of very old individuals</span>
<span class="fu">calculate_quasi_extinction</span><span class="op">(</span><span class="va">sims</span>, threshold <span class="op">=</span> <span class="fl">0</span>, subset <span class="op">=</span> <span class="fl">21</span><span class="op">:</span><span class="fl">30</span>, include <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<pre><code>## [1] 0.9287097</code></pre>
<p>These numbers indicate a relatively low risk of falling below threshold population sizes at the population level but do highlight a moderate risk of extinction of older individuals (21-30 years) during the 30 year modelled time period.</p>
<p>A more general output builds on the concept of quasi-extinction but extends this to consider a range of thresholds. This information can be captured in a risk curve that presents the probability of falling below any given threshold during the simulated time period. This output can be calculated with the following function, which uses the <code>calculate_quasi_extinction</code> function repeatedly with different values of <code>threshold</code>:</p>
<div class="sourceCode" id="cb31"><pre class="downlit">
<span class="co"># function to calculate quasi-extinction risk for multiple thresholds</span>
<span class="va">calculate_risk</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">popsim</span>, <span class="va">min</span>, <span class="va">max</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">1000</span>, <span class="va">subset</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">include</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>

  <span class="co"># create a sequence of threshold values</span>
  <span class="va">thresh_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">min</span>, <span class="va">max</span>, length <span class="op">=</span> <span class="va">n</span><span class="op">)</span>

  <span class="co"># calculate risk across the entire sequence and return</span>
  <span class="co">#   a data.frame with threshold and risk values</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    threshold <span class="op">=</span> <span class="va">thresh_seq</span>,
    risk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span>
      <span class="va">thresh_seq</span>,
      <span class="va">calculate_quasi_extinction</span>,
      popsim <span class="op">=</span> <span class="va">popsim</span>,
      subset <span class="op">=</span> <span class="va">subset</span>,
      include <span class="op">=</span> <span class="va">include</span>
    <span class="op">)</span>
  <span class="op">)</span>
  
<span class="op">}</span>

<span class="co"># calculate risk curve for thresholds from 0 to 10000</span>
<span class="va">risk_calc</span> <span class="op">&lt;-</span> <span class="fu">calculate_risk</span><span class="op">(</span><span class="va">sims</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">10000</span>, subset <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span>

<span class="co"># this can be plotted</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">risk</span> <span class="op">~</span> <span class="va">threshold</span>, data <span class="op">=</span> <span class="va">risk_calc</span>, xlab <span class="op">=</span> <span class="st">"Threshold population size (adult abundance)"</span>, ylab <span class="op">=</span> <span class="st">"Quasi-extinction probability"</span>, las <span class="op">=</span> <span class="fl">1</span>, bty <span class="op">=</span> <span class="st">"l"</span>, type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.9</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="macperch_example_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<p>A risk curve provides information on the likelihood of hitting any given population size at any point in time. This information can also be presented as the abundance that a population is likely to reach with some fixed probability. For example, it can be useful to state the abundance a population will reach with 50 %, 80 %, or 95 % probability. This information can be extracted from the risk curve with the following code:</p>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="co"># function to calculate threshold abundance reached with probability = prob</span>
<span class="va">calculate_threshold</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">risk</span>, <span class="va">threshold</span>, <span class="va">prob</span> <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">{</span>

  <span class="co"># find the rows in risk nearest to prob</span>
  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">prob</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">risk</span> <span class="op">-</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># then pull out and return these threshold values</span>
  <span class="va">threshold</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>

<span class="op">}</span>

<span class="co"># calculate these thresholds</span>
<span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span><span class="op">)</span>
<span class="va">thresh</span> <span class="op">&lt;-</span> <span class="fu">calculate_threshold</span><span class="op">(</span><span class="va">risk_calc</span><span class="op">$</span><span class="va">risk</span>, <span class="va">risk_calc</span><span class="op">$</span><span class="va">threshold</span>, prob <span class="op">=</span> <span class="va">probs</span><span class="op">)</span>

<span class="co"># plot these on the risk curve</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">risk</span> <span class="op">~</span> <span class="va">threshold</span>, data <span class="op">=</span> <span class="va">risk_calc</span>, xlab <span class="op">=</span> <span class="st">"Threshold population size (adult abundance)"</span>, ylab <span class="op">=</span> <span class="st">"Quasi-extinction probability"</span>, las <span class="op">=</span> <span class="fl">1</span>, bty <span class="op">=</span> <span class="st">"l"</span>, type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"#2171B5"</span>, <span class="fl">0.9</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">col_pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#67001F"</span>, <span class="st">"#D6604D"</span>, <span class="st">"#FDDBC7"</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">thresh</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">thresh</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">thresh</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.2</span>, <span class="va">probs</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">col_pal</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="va">thresh</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">probs</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">probs</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">col_pal</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">thresh</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, y <span class="op">=</span> <span class="op">(</span><span class="va">probs</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">thresh</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, pos <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p><img src="macperch_example_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-todd_lintermans2015">
<p>Todd, Charles R., and Mark Lintermans. 2015. “Who Do You Move? A Stochastic Population Model to Guide Translocation Strategies for an Endangered Freshwater Fish in South-Eastern Australia.” <em>Ecological Modelling</em> 311: 63–72. <a href="https://doi.org/10.1016/j.ecolmodel.2015.05.001">https://doi.org/10.1016/j.ecolmodel.2015.05.001</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://scholar.google.com.au/citations?user=oEmm1CMAAAAJ&amp;hl=en">Jian Yen</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
